<main class="container">
  <div class="filters-card rounded-card">
    <button
      class="filters-card__button rounded-button-slim"
      (click)="showFilterCardContent = !isDesktop ? !showFilterCardContent : true">
        <span>Filtros y búsqueda</span>
        <mat-icon class="small-icon">
          {{ showFilterCardContent && !isDesktop ? 'expand_less' : 'filter_alt' }}
        </mat-icon>
    </button>
    <div class="filters-card__content" *ngIf="showFilterCardContent" @inOutY>
      <!-- Searchbar -->
      <div class="rounded-search-bar">
        <input type="search" [formControl]="searchControl" placeholder="Buscar" (keyup.enter)="doSearch(1); updateHasFilters()">
        <button *ngIf="!!postFilters.search && postFilters.search === searchControl.value" mat-icon-button (click)="clearSearchControl()" matTooltip="Borrar">
          <mat-icon>close</mat-icon>
        </button>
        <button *ngIf="!!!postFilters.search || postFilters.search !== searchControl.value" mat-icon-button (click)="doSearch(1)" matTooltip="Buscar">
          <mat-icon>search</mat-icon>
        </button>
      </div>
  
      <mat-divider></mat-divider>
    
      <!-- Filters -->
      <div class="filters__selects">
        <app-rounded-select
          class="bg-text-academic-level"
          baseText="Nivel Académico"
          [control]="academicLevelControl"
          [options]="academicLevelsList"
          [resetButton]="true"
          [loading]="isAcademicLevelsLoading">
        </app-rounded-select>
        <app-rounded-select
          class="bg-text-axis"
          baseText="Eje"
          [control]="axisControl"
          [hasGroups]="true"
          [options]="subjectWithAxis"
          [searchInput]="true"
          searchPlaceholder="Busca un eje o asignatura"
          [resetButton]="true"
          [loading]="isAxesLoading">
        </app-rounded-select>
        <app-rounded-select
          class="bg-text-subject"
          baseText="Asignatura"
          [control]="subjectControl"
          [options]="subjectList"
          [searchInput]="true"
          searchPlaceholder="Busca una asignatura"
          [resetButton]="true"
          [loading]="isSubjectsLoading">
        </app-rounded-select>
        <app-rounded-select
          class="bg-text-blue-white"
          baseText="Ordenar por"
          [control]="orderingControl"
          [options]="orderingList">
        </app-rounded-select>
      </div>
      <button class="reset-filters-button" *ngIf="hasFilters" (click)="removeFilters()" matRipple @inOutY>
        <mat-icon class="small-icon">delete</mat-icon>
        <span class="fw-600">Borrar filtros</span>
      </button>
    </div>
  </div>
  
  <div class="main-content">
    <!-- Filter tags and pagination -->
    <div class="fs-small flex-end-center flex-wrap gap-05">
      <!-- Filter tags -->
      <div class="filter-tags flex-center-center gap-025 flex-wrap">
        <button
          *ngIf="!!postFilters.search && !!searchControl.value" @inOutLeft
          (click)="removeFilter('search')"
          matRipple
          class="rounded-button-slim">
            <mat-icon class="small-icon">search</mat-icon>
            <span>{{ postFilters.search|truncate:20  }}</span>
            <mat-icon class="small-icon" matTooltip="Remover">close</mat-icon>
        </button>
        <button
          *ngIf="!!academicLevelControl.value" @inOutLeft
          (click)="removeFilter('academicLevel')"
          matRipple
          class="rounded-button-slim bg-text-academic-level">
            <span>{{ academicLevelControl.value.data.name }}</span>
            <mat-icon class="small-icon" matTooltip="Remover">close</mat-icon>
        </button>
        <button
          *ngIf="!!axisControl.value" @inOutLeft
          (click)="removeFilter('axis')"
          matRipple
          class="rounded-button-slim bg-text-axis">
            <span>{{ axisControl.value.data.name }}</span>
            <mat-icon class="small-icon" matTooltip="Remover">close</mat-icon>
        </button>
        <button
          *ngIf="!!subjectControl.value" @inOutLeft
          (click)="removeFilter('subject')"
          matRipple
          class="rounded-button-slim bg-text-subject">
            <span>{{ subjectControl.value.data.name }}</span>
            <mat-icon class="small-icon" matTooltip="Remover">close</mat-icon>
        </button>
        <button
          *ngIf="!!orderingControl.value && orderingControl.value.data.id !== orderingType.MOST_RECENT" @inOutLeft
          (click)="removeFilter('ordering')"
          matRipple
          class="rounded-button-slim bg-text-blue-white">
            <mat-icon class="small-icon">sort</mat-icon>
            <span>{{ orderingControl.value.data.name }}</span>
            <mat-icon class="small-icon" matTooltip="Remover">close</mat-icon>
        </button>
      </div>
    
      <!-- Pagination -->
      <div class="pagination flex-center-center gap-05">
        <span class="fw-700 fs-regular" *ngIf="!isLoading && hasData" @inOutRight>
          {{ (pageInfo?.maxPage ?? 0) * (postFilters.page! - 1) + 1 }}
           - {{ (pageInfo?.maxPage ?? 0) * (postFilters.page! - 1) + posts.length }}
          de {{ pageInfo?.count }}
        </span>
        <div class="flex-center-center gap-025">
          <button class="circle-button" (click)="previousPage()" [disabled]="!pageInfo?.previous || isLoading" aria-label="Pág. Anterior" matTooltip="Pág. Anterior" matRipple>
            <mat-icon class="small-icon">navigate_before</mat-icon>
          </button>
          <button class="circle-button fs-medium" [matMenuTriggerFor]="pagesMenu" aria-label="Seleccionar página" matTooltip="Seleccionar página" matRipple [disabled]="isLoading || !hasData">
            <span class="fs-small fw-700">{{ postFilters.page }}</span>
          </button>
          <mat-menu #pagesMenu>
            <button mat-menu-item *ngFor="let page of (pageInfo?.maxPage ?? 1)|fillArray" (click)="doSearch(page)">
              {{ page }}
            </button>
          </mat-menu>
          <button class="circle-button" (click)="nextPage()" [disabled]="!pageInfo?.next || isLoading" aria-label="Pág. Siguiente" matTooltip="Pág. Siguiente" matRipple>
            <mat-icon class="small-icon">navigate_next</mat-icon>
          </button>
        </div>
      </div>
    </div>

    <!-- Post grid -->
    <section class="posts-grid" *ngIf="!isLoading && hasData" @fadeInOut>
      <div class="rounded-card flex-column flex-space_between gap-07" *ngFor="let post of posts">
        <div class="flex-space_between-center">
          <p>{{ post.user.fullName }} - {{ post.createdAt|timeAgo }}</p>

          <button mat-icon-button [matMenuTriggerFor]="menu" aria-label="Opciones" matTooltip="Opciones" class="reset-mat-icon-button">
            <mat-icon class="text-blue-dark">more_vert</mat-icon>
          </button>
          <mat-menu #menu="matMenu">
            <button mat-menu-item (click)="report(post)">
              <mat-icon>report</mat-icon>
              <span>Reportar</span>
            </button>
          </mat-menu>
        </div>
  
        <div>
          <h2><a [routerLink]="['/posts/view', post.id]" class="reset-link-style">
            {{ post.title }}
          </a></h2>
          <p><a [routerLink]="['/posts/view', post.id]" class="reset-link-style">
            {{ post.shortDescription }}
          </a></p>
        </div>
  
        <div class="flex-space_between-center flex-wrap gap-025">
          <div class="flex-center-center gap-025">
            <mat-icon class="text-blue-dark">description</mat-icon>
            <span class="fw-600">{{ post.totalFiles }} Documentos</span>
          </div>
  
          <div class="flex-wrap gap-025">
            <span class="small-border-tag-{{ post.mainFile.tagColor }}">{{ post.mainFile.ext }}</span>
            <ng-container *ngFor="let file of post.suportingMaterial">
              <span class="small-border-tag-{{ file.tagColor }}">{{ file.ext }}</span>
            </ng-container>
          </div>
        </div>
  
        <div class="flex-wrap gap-025">
          <span class="rounded-button-slim bg-text-academic-level">Nivel académico: {{ post.academicLevel.name }}</span>
          <span class="rounded-button-slim bg-text-axis">Eje: {{ post.axis.name }}</span>
          <span class="rounded-button-slim bg-text-subject">Asignatura: {{ post.axis.subject.name }}</span>
        </div>
  
        <div class="flex-space_between-center">
          <div class="flex-center-center gap-1">
            <div class="flex-center-center gap-025">
              <mat-icon class="small-icon text-blue-dark">favorite_outline</mat-icon>
              <span class="fw-600">{{ post.totalLikes }} Me gusta</span>
            </div>
            <div class="flex-center-center gap-025">
              <mat-icon class="small-icon text-blue-dark">visibility</mat-icon>
              <span class="fw-600">{{ post.totalLikes }} Visualizaciones</span>
            </div>
          </div>
  
          <mat-icon class="text-red">
            {{ post.alreadyLiked ? 'favorite' : 'favorite_outline' }}
          </mat-icon>
        </div>
      </div>
    </section>

    <!-- Post shimmer grid -->
    <div class="posts-grid" *ngIf="isLoading" @fadeInOut>
      <!-- Post card shimmer -->
      <div class="rounded-card flex-column flex-space_between gap-07" *ngFor="let post of 6|fillArray">
        <div class="flex-space_between-center">
          <div class="shimmer-text-regular grow-1"></div>
          <mat-icon class="shimmer-text-color">more_vert</mat-icon>
        </div>

        <div>
          <div class="shimmer-text-large"></div>
          <div class="shimmer-text-regular"></div>
          <div class="shimmer-text-regular w-40"></div>
        </div>

        <div class="flex-space_between-center">
          <div class="flex-start-center gap-025 w-50">
            <mat-icon class="shimmer-text-color">description</mat-icon>
            <div class="shimmer-text-regular grow-1"></div>
          </div>

          <div class="flex-end-center gap-025 w-50">
            <div class="shimmer-text-regular w-20"></div>
            <div class="shimmer-text-regular w-20"></div>
          </div>
        </div>

        <div class="flex-space_between-center gap-025 w-100">
          <div class="shimmer-text-large w-30"></div>
          <div class="shimmer-text-large w-30"></div>
          <div class="shimmer-text-large w-30"></div>
        </div>

        <div class="flex-space_between-center gap-1">
          <div class="flex-center-center gap-1 grow-1">
            <div class="flex-center-center gap-025 w-100">
              <mat-icon class="small-icon shimmer-text-color">favorite_outline</mat-icon>
              <div class="shimmer-text-regular grow-1"></div>
            </div>
            <div class="flex-center-center gap-025 w-100">
              <mat-icon class="small-icon shimmer-text-color">visibility</mat-icon>
              <div class="shimmer-text-regular grow-1"></div>
            </div>
          </div>

          <mat-icon class="shimmer-text-color">favorite</mat-icon>
        </div>
      </div>
    </div>

    <!-- No results -->
    <div class="flex-column flex-center-center text-center gap-05 m-t-2" *ngIf="!hasData && !isLoading" @fadeInOut>
      <img class="no-results-image" src="assets/images/no-results.png" alt="Perdido en el espacio">
      <p class="fs-medium fw-700">No se han encontrado resultados</p>
      <p class="fw-700">Aún nadie ha creado una publicación con tus parámetros de búsqueda 😅</p>
    </div>
  </div>
</main>
